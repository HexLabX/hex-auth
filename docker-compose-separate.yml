version: '3.8'

# 网络配置
networks:
  hex-auth-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# 后端服务
services:
  # 后端API服务
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: hex-auth-backend
    restart: always
    networks:
      - hex-auth-network
    environment:
      # 数据库连接配置（连接到宿主机已有的MySQL）
      DATABASE_URL: "mysql+pymysql://root:password@host.docker.internal:3306/hex_auth"
      # 或者使用宿主机IP地址
      # DATABASE_URL: "mysql+pymysql://root:password@192.168.1.100:3306/hex_auth"
      SECRET_KEY: "your-secret-key"
      # JWT配置
      ALGORITHM: "HS256"
      ACCESS_TOKEN_EXPIRE_MINUTES: "30"
      # RSA配置
      RSA_PRIVATE_KEY_PATH: "./keys/private.pem"
      RSA_PUBLIC_KEY_PATH: "./keys/public.pem"
    ports:
      - "8000:8000"
    volumes:
      # 挂载RSA密钥目录（如果需要的话）
      - ./backend/keys:/app/keys:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"  # 允许容器访问宿主机

  # 前端服务
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: hex-auth-frontend
    restart: always
    networks:
      - hex-auth-network
    ports:
      - "8080:80"  # 前端容器内部使用80端口，映射到宿主机8080端口
    depends_on:
      - backend
    # 注意：由于宿主机已安装Nginx，这里的前端容器端口将由宿主机Nginx反向代理
