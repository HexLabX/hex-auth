# 宿主机Nginx配置示例
# 保存到：/etc/nginx/conf.d/hex-auth.conf

# 后端API服务配置
server {
    listen 80;
    server_name api.example.com;  # 替换为你的API域名
    
    # 配置HTTPS（可选，推荐）
    # listen 443 ssl;
    # ssl_certificate /path/to/ssl/cert.pem;
    # ssl_certificate_key /path/to/ssl/key.pem;
    
    # 反向代理到后端Docker容器
    location / {
        proxy_pass http://localhost:8000;  # 后端容器映射到宿主机8000端口
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket支持（如果需要）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    # 健康检查端点（可选）
    location /health {
        proxy_pass http://localhost:8000/health;
        access_log off;
        error_log off;
        allow 127.0.0.1;
        deny all;
    }
}

# 前端服务配置
server {
    listen 80;
    server_name auth.example.com;  # 替换为你的前端域名
    
    # 配置HTTPS（可选，推荐）
    # listen 443 ssl;
    # ssl_certificate /path/to/ssl/cert.pem;
    # ssl_certificate_key /path/to/ssl/key.pem;
    
    # 反向代理到前端Docker容器
    location / {
        proxy_pass http://localhost:8080;  # 前端容器映射到宿主机8080端口
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 处理Vue路由的history模式
        try_files $uri $uri/ @rewrites;
    }
    
    # 重写规则，处理Vue路由
    location @rewrites {
        rewrite ^(.+)$ /index.html break;
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 静态资源直接返回，提高性能（可选）
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_cache_bypass $http_cache_control;
        add_header Cache-Control "public, max-age=31536000";
    }
}
